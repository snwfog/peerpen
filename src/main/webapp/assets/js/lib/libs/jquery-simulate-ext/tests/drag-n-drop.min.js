(function(a,b){a(document).ready(function(){module("drag-n-drop",{setup:function(){tests.testSetup();a(document).on("simulate-drag simulate-drop","#qunit-fixture",tests.assertExpectedEvent)},teardown:function(){a(document).off("simulate-drag simulate-drop","#qunit-fixture");tests.testTearDown();if(a.simulate.activeDrag()){a(document).simulate("drop",{debug:false})}}});test("drag",function(){var g=a("#dragArea");var i=50,h=10;var e=Math.round(g.offset().left+g.outerWidth()/2),c=Math.round(g.offset().top+g.outerHeight()/2);var f=Math.round(g.offset().left+g.outerWidth()/2)+i,d=Math.round(g.offset().top+g.outerHeight()/2)+h;tests.expectedEvents=[{type:"mousedown",pageX:e,pageY:c},{type:"mousemove",pageX:f,pageY:d},{type:"simulate-drag"}];g.simulate("drag",{dx:i,dy:h})});test("drag callback",function(){var e=a("#dragArea");var g=50,f=10;var d=Math.round(e.offset().left+e.outerWidth()/2)+g,c=Math.round(e.offset().top+e.outerHeight()/2)+f;tests.expectedEvents=[{type:"mousedown"},{type:"mousemove",pageX:d,pageY:c},{type:"simulate-drag"},{type:"callback"}];e.simulate("drag",{dx:g,dy:f,callback:function(){tests.assertExpectedEvent({type:"callback"})}})});test("drag on target",function(){var f=a("#dragArea"),d=a("#dropArea");var e=Math.round(d.offset().left+d.outerWidth()/2),c=Math.round(d.offset().top+d.outerHeight()/2);tests.expectedEvents=[{type:"mousedown"},{type:"mousemove",pageX:e,pageY:c},{type:"simulate-drag"}];f.simulate("drag",{dragTarget:d})});test("drop",function(){var e=a("#dropArea");var d=Math.round(e.offset().left+e.outerWidth()/2),c=Math.round(e.offset().top+e.outerHeight()/2);tests.expectedEvents=[{type:"mousemove",pageX:d,pageY:c},{type:"mouseup",pageX:d,pageY:c},{type:"simulate-drop"}];e.simulate("drop")});test("drop callback",function(){var e=a("#dropArea");var d=Math.round(e.offset().left+e.outerWidth()/2),c=Math.round(e.offset().top+e.outerHeight()/2);tests.expectedEvents=[{type:"mousemove",pageX:d,pageY:c},{type:"mouseup"},{type:"simulate-drop"},{type:"callback"}];e.simulate("drop",{callback:function(){tests.assertExpectedEvent({type:"callback"})}})});test("drag-n-drop",function(){var e=a("#dragArea");var g=50,f=10;var d=Math.round(e.offset().left+e.outerWidth()/2)+g,c=Math.round(e.offset().top+e.outerHeight()/2)+f;tests.expectedEvents=[{type:"mousedown"},{type:"mousemove",pageX:d,pageY:c},{type:"simulate-drag"},{type:"mouseup",pageX:d,pageY:c},{type:"simulate-drop"}];e.simulate("drag-n-drop",{dx:g,dy:f})});test("drag-n-drop callback",function(){var e=a("#dragArea");var g=50,f=10;var d=Math.round(e.offset().left+e.outerWidth()/2)+g,c=Math.round(e.offset().top+e.outerHeight()/2)+f;tests.expectedEvents=[{type:"mousedown"},{type:"mousemove",pageX:d,pageY:c},{type:"simulate-drag"},{type:"mouseup",pageX:d,pageY:c},{type:"simulate-drop"},{type:"callback"}];e.simulate("drag-n-drop",{dx:g,dy:f,callback:function(){tests.assertExpectedEvent({type:"callback"})}})});test("drag-n-drop on scrolled viewport",function(){var h=a("#dragArea"),f=a("#dropArea");if(document.elementFromPoint(-1,-1)===null){a("#qunit-fixture").css({top:"auto",left:"auto",position:"inherit"});a(document).scrollTop(f.offset().top)}else{a(document).scrollTop(500)}var j=50,i=Math.round(f.offset().top-h.offset().top);var e=Math.round(h.offset().left+h.outerWidth()/2),c=Math.round(h.offset().top+h.outerHeight()/2);var g=Math.round(h.offset().left+h.outerWidth()/2)+j,d=Math.round(h.offset().top+h.outerHeight()/2)+i;tests.expectedEvents=[{type:"mousedown",pageX:e,pageY:c},{type:"mousemove",pageX:g,pageY:d},{type:"simulate-drag"},{type:"mouseup",pageX:g,pageY:d,target:f[0]},{type:"simulate-drop"}];h.simulate("drag-n-drop",{dx:j,dy:i});a("#qunit-fixture").css({top:"",left:"",position:""});a(document).scrollTop(0)});test("multiple drags, then drop",function(){var g=a("#dragArea");var f=[{x:50,y:10},{x:7,y:-30},{x:-20,y:-5}];var d=Math.round(g.offset().left+g.outerWidth()/2),c=Math.round(g.offset().top+g.outerHeight()/2);tests.expectedEvents=[{type:"mousedown"}];var e;for(e=0;e<f.length;e+=1){d+=f[e].x;c+=f[e].y;tests.expectedEvents.push({type:"mousemove",pageX:d,pageY:c},{type:"simulate-drag"})}tests.expectedEvents.push({type:"mouseup",pageX:d,pageY:c},{type:"simulate-drop"});for(e=0;e<f.length;e+=1){g.simulate("drag",{dx:f[e].x,dy:f[e].y})}g.simulate("drop")});test("drag on target, then drop",function(){var f=a("#dragArea"),d=a("#dropArea");var e=Math.round(d.offset().left+d.outerWidth()/2),c=Math.round(d.offset().top+d.outerHeight()/2);tests.expectedEvents=[{type:"mousedown"},{type:"mousemove",pageX:e,pageY:c},{type:"simulate-drag"},{type:"mouseup",pageX:e,pageY:c},{type:"simulate-drop"}];f.simulate("drag",{dragTarget:d});f.simulate("drop")});test("drag, then drop on different target",function(){var f=a("#dragArea"),d=a("#dropArea");var e=10,c=20;var j=Math.round(f.offset().left+f.outerWidth()/2)+e,i=Math.round(f.offset().top+f.outerHeight()/2)+c,h=Math.round(d.offset().left+d.outerWidth()/2),g=Math.round(d.offset().top+d.outerHeight()/2);tests.expectedEvents=[{type:"mousedown"},{type:"mousemove",pageX:j,pageY:i},{type:"simulate-drag"},{type:"mousemove",pageX:h,pageY:g},{type:"mouseup",pageX:h,pageY:g},{type:"simulate-drop"}];f.simulate("drag",{dx:e,dy:c});d.simulate("drop")});test("drop before another drag",function(){var k=a("#dragArea"),i=a("#dropArea");var l=10,j=5,f=50,e=10;var h=Math.round(k.offset().left+k.outerWidth()/2)+l,g=Math.round(k.offset().top+k.outerHeight()/2)+j,d=Math.round(i.offset().left+i.outerWidth()/2)+f,c=Math.round(i.offset().top+i.outerHeight()/2)+e;tests.expectedEvents=[{type:"mousedown"},{type:"mousemove",pageX:h,pageY:g},{type:"simulate-drag"},{type:"mouseup",pageX:h,pageY:g},{type:"simulate-drop"},{type:"mousedown"},{type:"mousemove",pageX:d,pageY:c},{type:"simulate-drag"}];k.simulate("drag",{dx:l,dy:j});i.simulate("drag",{dx:f,dy:e})});test("move before drop",function(){var f=a("#dragArea"),d=a("#dropArea");var e=Math.round(d.offset().left+d.outerWidth()/2),c=Math.round(d.offset().top+d.outerHeight()/2);tests.expectedEvents=[{type:"mousedown"},{type:"simulate-drag"},{type:"mousemove",pageX:e,pageY:c},{type:"mouseup"},{type:"simulate-drop"}];f.simulate("drag");d.simulate("drop")});test("document drop",function(){var g=a("#dragArea");var f=17,d=102;var e=Math.round(g.offset().left+g.outerWidth()/2)+f,c=Math.round(g.offset().top+g.outerHeight()/2)+d;tests.expectedEvents=[{type:"mousedown"},{type:"mousemove",pageX:e,pageY:c},{type:"simulate-drag"},{type:"mouseup",pageX:e,pageY:c},{type:"simulate-drop"}];g.simulate("drag",{dx:f,dy:d});a(document).simulate("drop")});test("drag-n-drop on target",function(){var f=a("#dragArea"),d=a("#dropArea");var e=Math.round(d.offset().left+d.outerWidth()/2),c=Math.round(d.offset().top+d.outerHeight()/2);tests.expectedEvents=[{type:"mousedown"},{type:"mousemove",pageX:e,pageY:c},{type:"simulate-drag"},{type:"mouseup",pageX:e,pageY:c},{type:"simulate-drop"}];f.simulate("drag-n-drop",{dropTarget:d})});test("drag-n-drop with drag and drop target",function(){var f=a("#dragArea"),d=a("#dropArea");var e=10,c=-132;var j=Math.round(f.offset().left+f.outerWidth()/2)+e,i=Math.round(f.offset().top+f.outerHeight()/2)+c,h=Math.round(d.offset().left+d.outerWidth()/2),g=Math.round(d.offset().top+d.outerHeight()/2);tests.expectedEvents=[{type:"mousedown"},{type:"mousemove",pageX:j,pageY:i},{type:"simulate-drag"},{type:"mousemove",pageX:h,pageY:g},{type:"mouseup",pageX:h,pageY:g},{type:"simulate-drop"}];f.simulate("drag-n-drop",{dx:e,dy:c,dropTarget:d})});test("drag-n-drop with drag target and drop target",function(){var e=a("#dragArea"),d=a("#dropArea"),c=a("#dropArea2");var i=Math.round(d.offset().left+d.outerWidth()/2),h=Math.round(d.offset().top+d.outerHeight()/2),g=Math.round(c.offset().left+c.outerWidth()/2),f=Math.round(c.offset().top+c.outerHeight()/2);tests.expectedEvents=[{type:"mousedown"},{type:"mousemove",pageX:i,pageY:h},{type:"simulate-drag"},{type:"mousemove",pageX:g,pageY:f},{type:"mouseup",pageX:g,pageY:f},{type:"simulate-drop"}];e.simulate("drag-n-drop",{dragTarget:d,dropTarget:c})});test("interpolated drag",function(){var c=a("#dragArea");var f=Math.round(c.offset().left+c.outerWidth()/2),e=Math.round(c.offset().top+c.outerHeight()/2);var j=5,h=60,g=40;tests.expectedEvents=[{type:"mousedown"}];for(var d=1;d<=j;d+=1){tests.expectedEvents.push({type:"mousemove",pageX:Math.round(f+d*h/(j+1)),pageY:Math.round(e+d*g/(j+1))})}tests.expectedEvents.push({type:"mousemove",pageX:f+h,pageY:e+g},{type:"simulate-drag"});c.simulate("drag",{dx:h,dy:g,interpolation:{stepCount:j}})});test("interpolated drag across elements",function(){var c=a("#dragArea"),k=a("#dropArea");if(document.elementFromPoint(-1,-1)===null){a("#qunit-fixture").css({top:"auto",left:"auto",position:"inherit"});a(document).scrollTop(k.offset().top)}var j=Math.round(c.offset().left+c.outerWidth()/2),h=Math.round(c.offset().top+c.outerHeight()/2),o=Math.round(k.offset().left+k.outerWidth()/2),m=Math.round(k.offset().top+k.outerHeight()/2);var f=5,p=o-j,n=m-h,l=c[0],e,d;tests.expectedEvents=[{type:"mousedown"}];for(var g=1;g<=f;g+=1){e=Math.round(j+g*p/(f+1));d=Math.round(h+g*n/(f+1));if(e>=k.offset().left&&d>=k.offset().top){l=k[0]}tests.expectedEvents.push({type:"mousemove",pageX:e,pageY:d,target:l})}tests.expectedEvents.push({type:"mousemove",pageX:j+p,pageY:h+n},{type:"simulate-drag"});c.simulate("drag",{dragTarget:k,interpolation:{stepCount:f}});a("#qunit-fixture").css({top:"",left:"",position:""});a(document).scrollTop(0)});test("interpolated drag using stepWidth",function(){var c=a("#dragArea");var f=Math.round(c.offset().left+c.outerWidth()/2),e=Math.round(c.offset().top+c.outerHeight()/2);var j=2,h=30,g=(j+1)*h;tests.expectedEvents=[{type:"mousedown"}];for(var d=1;d<=j+1;d+=1){tests.expectedEvents.push({type:"mousemove",pageX:f+d*h,pageY:e})}tests.expectedEvents.push({type:"simulate-drag"});c.simulate("drag",{dx:g,interpolation:{stepWidth:h}})});test("interpolated drag using stepCount",function(){var c=a("#dragArea");var f=Math.round(c.offset().left+c.outerWidth()/2),e=Math.round(c.offset().top+c.outerHeight()/2);var j=2,g=90,h=g/(j+1);tests.expectedEvents=[{type:"mousedown"}];for(var d=1;d<=j+1;d+=1){tests.expectedEvents.push({type:"mousemove",pageX:f+d*h,pageY:e})}tests.expectedEvents.push({type:"simulate-drag"});c.simulate("drag",{dx:g,interpolation:{stepCount:j}})});test("interpolated, shaky drag",function(){var d=a("#dragArea");var e=[];var l=10;function c(i){if(tests.expectedEvents.length===0){ok(false,"Unexpected event: "+i.type);return}for(var o in tests.expectedEvents[0]){if(tests.expectedEvents[0].hasOwnProperty(o)){if(o==="pageX"||o==="pageY"){QUnit.close(i[o],tests.expectedEvents[0][o],l,"Comparing "+o+" (expected: "+tests.expectedEvents[0][o]+"±"+l+")");if(o==="pageY"){e[i[o]]=e[i[o]]+1||1}}else{strictEqual(i[o],tests.expectedEvents[0][o],"Comparing "+o+" (expected: "+tests.expectedEvents[0][o]+")")}}}if(i.type===tests.expectedEvents[0].type){tests.expectedEvents.shift()}}a(document).off("mousemove","#qunit-fixture",tests.assertExpectedEvent).on("mousemove","#qunit-fixture",c);var j=Math.round(d.offset().left+d.outerWidth()/2),h=Math.round(d.offset().top+d.outerHeight()/2);var f=2,k=90,n=k/(f+1);tests.expectedEvents=[{type:"mousedown"}];var g;for(g=1;g<=f+1;g+=1){tests.expectedEvents.push({type:"mousemove",pageX:j+g*n,pageY:h})}tests.expectedEvents.push({type:"simulate-drag"});d.simulate("drag",{dx:k,interpolation:{stepCount:f,shaky:l}});var m=0;for(g in e){if(e.hasOwnProperty(g)){m+=1}}ok(m>1,"Verify shaky positions are random (if this test fails, rerun to rule out the unlikely case that all random positions were equal)")});test("interpolated, delayed drag",function(){var c=a("#dragArea");var d=100,g;function m(n){var i=Date.now()-g;ok(i>=d-10,"Verify events occur delayed (delay: "+i+")");if(tests.expectedEvents.length===0){ok(false,"Unexpected event: "+n.type);return}for(var o in tests.expectedEvents[0]){if(tests.expectedEvents[0].hasOwnProperty(o)){strictEqual(n[o],tests.expectedEvents[0][o],"Comparing "+o+" (expected: "+tests.expectedEvents[0][o]+")")}}if(n.type===tests.expectedEvents[0].type){tests.expectedEvents.shift()}g=Date.now()}a(document).off("mousemove","#qunit-fixture",tests.assertExpectedEvent).on("mousemove","#qunit-fixture",m);var j=Math.round(c.offset().left+c.outerWidth()/2),h=Math.round(c.offset().top+c.outerHeight()/2);var e=2,k=90,l=k/(e+1);tests.expectedEvents=[{type:"mousedown"}];for(var f=1;f<=e+1;f+=1){tests.expectedEvents.push({type:"mousemove",pageX:j+f*l,pageY:h})}tests.expectedEvents.push({type:"simulate-drag"});stop();g=Date.now();c.simulate("drag",{dx:k,interpolation:{stepCount:e,stepDelay:d}});setTimeout(function(){start()},(e+2)*d)});test("interpolated, delayed drag using duration",function(){var c=a("#dragArea");var d=100,g;function m(n){var i=Date.now()-g;ok(i>=d-10,"Verify events occur delayed (delay: "+i+")");if(tests.expectedEvents.length===0){ok(false,"Unexpected event: "+n.type);return}for(var o in tests.expectedEvents[0]){if(tests.expectedEvents[0].hasOwnProperty(o)){strictEqual(n[o],tests.expectedEvents[0][o],"Comparing "+o+" (expected: "+tests.expectedEvents[0][o]+")")}}if(n.type===tests.expectedEvents[0].type){tests.expectedEvents.shift()}g=Date.now()}a(document).off("mousemove","#qunit-fixture",tests.assertExpectedEvent).on("mousemove","#qunit-fixture",m);var j=Math.round(c.offset().left+c.outerWidth()/2),h=Math.round(c.offset().top+c.outerHeight()/2);var e=2,k=90,l=k/(e+1);tests.expectedEvents=[{type:"mousedown"}];for(var f=1;f<=e+1;f+=1){tests.expectedEvents.push({type:"mousemove",pageX:j+f*l,pageY:h})}tests.expectedEvents.push({type:"simulate-drag"});stop();g=Date.now();c.simulate("drag",{dx:k,interpolation:{stepCount:e,duration:(e+1)*d}});setTimeout(function(){start()},(e+2)*d)});test("interpolated, delayed drag-n-drop",function(){var c=a("#dragArea");var d=100,g;function m(n){var i=Date.now()-g;ok(i>=d-10,"Verify events occur delayed (delay: "+i+")");if(tests.expectedEvents.length===0){ok(false,"Unexpected event: "+n.type);return}for(var o in tests.expectedEvents[0]){if(tests.expectedEvents[0].hasOwnProperty(o)){strictEqual(n[o],tests.expectedEvents[0][o],"Comparing "+o+" (expected: "+tests.expectedEvents[0][o]+")")}}if(n.type===tests.expectedEvents[0].type){tests.expectedEvents.shift()}g=Date.now()}a(document).off("mousemove","#qunit-fixture",tests.assertExpectedEvent).on("mousemove","#qunit-fixture",m);var j=Math.round(c.offset().left+c.outerWidth()/2),h=Math.round(c.offset().top+c.outerHeight()/2);var e=2,k=90,l=k/(e+1);tests.expectedEvents=[{type:"mousedown"}];for(var f=1;f<=e+1;f+=1){tests.expectedEvents.push({type:"mousemove",pageX:j+f*l,pageY:h})}tests.expectedEvents.push({type:"simulate-drag"},{type:"mouseup",pageX:j+(e+1)*l,pageY:h},{type:"simulate-drop"});stop();g=Date.now();c.simulate("drag-n-drop",{dx:k,interpolation:{stepCount:e,stepDelay:d}});setTimeout(function(){start()},(e+2)*d)});test("interpolated, delayed drag-n-drop on target",function(){var d=a("#dragArea"),c=a("#dropArea");var e=100,h;function p(q){var i=Date.now()-h;ok(i>=e-10,"Verify events occur delayed (delay: "+i+")");if(tests.expectedEvents.length===0){ok(false,"Unexpected event: "+q.type);return}for(var r in tests.expectedEvents[0]){if(tests.expectedEvents[0].hasOwnProperty(r)){strictEqual(q[r],tests.expectedEvents[0][r],"Comparing "+r+" (expected: "+tests.expectedEvents[0][r]+")")}}if(q.type===tests.expectedEvents[0].type){tests.expectedEvents.shift()}h=Date.now()}a(document).off("mousemove","#qunit-fixture",tests.assertExpectedEvent).on("mousemove","#qunit-fixture",p);var k=Math.round(d.offset().left+d.outerWidth()/2),j=Math.round(d.offset().top+d.outerHeight()/2),o=Math.round(c.offset().left+c.outerWidth()/2),n=Math.round(c.offset().top+c.outerHeight()/2);var f=2,m=(o-k)/(f+1),l=(n-j)/(f+1);tests.expectedEvents=[{type:"mousedown"}];for(var g=1;g<=f+1;g+=1){tests.expectedEvents.push({type:"mousemove",pageX:Math.round(k+g*m),pageY:Math.round(j+g*l)})}tests.expectedEvents.push({type:"simulate-drag"},{type:"mouseup",pageX:o,pageY:n},{type:"simulate-drop"});stop();h=Date.now();d.simulate("drag-n-drop",{dropTarget:c,interpolation:{stepCount:f,stepDelay:e}});setTimeout(function(){start()},(f+2)*e)});test("drag-n-drop within iFrame",function(){function c(){var i=window.frames[0].document,h=a(i.getElementById("iframe-dragArea")),f=a(i.getElementById("iframe-dropArea"));a(document).off("keyup keydown keypress mousedown mouseup mousemove simulate-drag simulate-drop","#qunit-fixture",tests.assertExpectedEvent);a(i).on("keyup keydown keypress mousedown mouseup mousemove simulate-drag simulate-drop","body",tests.assertExpectedEvent);var g=Math.round(f.offset().left+f.outerWidth()/2),e=Math.round(f.offset().top+f.outerHeight()/2);tests.expectedEvents=[{type:"mousedown"},{type:"mousemove",pageX:g,pageY:e},{type:"simulate-drag"},{type:"mouseup",pageX:g,pageY:e},{type:"simulate-drop"}];a(h).simulate("drag-n-drop",{dropTarget:f});a(i).off("keyup keydown keypress mousedown mouseup mousemove simulate-drag simulate-drop",tests.assertExpectedEvent)}stop();function d(){var f=window.frames[0].document,e=a(f.getElementById("iframe-dropArea"));if(e.length!==0){a(document).scrollTop(500);c();a(document).scrollTop(0);start()}else{setTimeout(d,100)}}d()});test("clickToDrag / clickToDrop",function(){var e=a("#dragArea");var g=50,f=10;var d=Math.round(e.offset().left+e.outerWidth()/2)+g,c=Math.round(e.offset().top+e.outerHeight()/2)+f;tests.expectedEvents=[{type:"mousedown"},{type:"mouseup"},{type:"click"},{type:"mousemove",pageX:d,pageY:c},{type:"simulate-drag"},{type:"mousedown"},{type:"mouseup",pageX:d,pageY:c},{type:"click"},{type:"simulate-drop"}];e.simulate("drag-n-drop",{dx:g,dy:f,clickToDrag:true,clickToDrop:true})})})}(jQuery));